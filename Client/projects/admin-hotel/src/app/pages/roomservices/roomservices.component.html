<div class="wrapper room-services-page">
  <app-sidebar></app-sidebar>
  <div class="content-page">
    <div class="content content-wrapper">
      <app-header></app-header>
      <div class="container-fluid py-4">
        <!-- start page title -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h4 class="page-title mb-0">Quản lý dịch vụ phòng</h4>
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb m-0 mt-2">
                    <li class="breadcrumb-item"><a href="javascript: void(0);" class="text-decoration-none">Trang
                        chủ</a></li>
                    <li class="breadcrumb-item"><a href="javascript: void(0);" class="text-decoration-none">Quản lý</a>
                    </li>
                    <li class="breadcrumb-item active">Dịch vụ phòng</li>
                  </ol>
                </nav>
              </div>
              <button data-bs-toggle="modal" data-bs-target="#service-modal"
                class="btn btn-primary rounded-pill d-flex align-items-center">
                <i class="mdi mdi-plus-circle me-1"></i> Thêm dịch vụ mới
              </button>
            </div>
          </div>
        </div>
        <!-- end page title -->

        <!-- Dashboard cards -->
        <div class="row mb-4 fade-in">
          <div class="col-md-4">
            <div class="card dashboard-card">
              <div class="card-body">
                <div class="card-icon bg-primary-lighten text-primary">
                  <i class="mdi mdi-room-service mdi-24px"></i>
                </div>
                <h2 class="card-number">{{getTotalServices()}}</h2>
                <p class="card-label mb-0">Tổng số dịch vụ</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card dashboard-card">
              <div class="card-body">
                <div class="card-icon bg-success-lighten text-success">
                  <i class="mdi mdi-check-circle mdi-24px"></i>
                </div>
                <h2 class="card-number">{{getActiveServices()}}</h2>
                <p class="card-label mb-0">Dịch vụ đang hoạt động</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card dashboard-card">
              <div class="card-body">
                <div class="card-icon bg-info-lighten text-info">
                  <i class="mdi mdi-file-document mdi-24px"></i>
                </div>
                <h2 class="card-number">{{roomServices.length > 0 ? roomServices.length : 0}}</h2>
                <p class="card-label mb-0">Dịch vụ có sẵn</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Advanced filter section -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="filter-section fade-in">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="m-0">Bộ lọc nâng cao</h5>
                <button class="btn btn-sm btn-outline-secondary" (click)="toggleFilterSection()">
                  <i class="mdi" [ngClass]="showFilters ? 'mdi-chevron-up' : 'mdi-chevron-down'"></i>
                </button>
              </div>

              <div class="row g-3" *ngIf="showFilters">
                <div class="col-md-4">
                  <div class="form-group">
                    <label class="form-label">Tìm kiếm</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="mdi mdi-magnify"></i></span>
                      <input type="text" [(ngModel)]="searchTerm" class="form-control filter-control"
                        placeholder="Tìm theo tên, mô tả...">
                    </div>
                  </div>
                </div>
                <div class="col-12 d-flex justify-content-end mt-3">
                  <button type="button" class="btn btn-outline-secondary me-2" (click)="clearFilters()">
                    <i class="mdi mdi-refresh me-1"></i> Đặt lại
                  </button>
                  <button type="button" class="btn btn-primary" (click)="applyFilters()">
                    <i class="mdi mdi-filter me-1"></i> Áp dụng bộ lọc
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- View toggle buttons -->
        <div class="row mb-3">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
              <div class="view-toggle">
                <button class="btn" [ngClass]="{'active': viewMode === 'card'}" (click)="setViewMode('card')">
                  <i class="mdi mdi-view-grid-outline me-1"></i> Thẻ
                </button>
                <button class="btn" [ngClass]="{'active': viewMode === 'table'}" (click)="setViewMode('table')">
                  <i class="mdi mdi-table me-1"></i> Bảng
                </button>
              </div>
              <div class="d-flex align-items-center">
                <button type="button" class="btn btn-light btn-sm me-2" (click)="exportToExcel()">
                  <i class="mdi mdi-download me-1"></i> Xuất Excel
                </button>
                <div class="dropdown">
                  <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="sortDropdown"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="mdi mdi-sort me-1"></i> Sắp xếp
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                    <li><a class="dropdown-item" href="javascript:void(0);" (click)="sortBy('nameAsc')">Tên A-Z</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0);" (click)="sortBy('nameDesc')">Tên Z-A</a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading spinner -->
        <div class="text-center py-5" *ngIf="isLoading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
          </div>
          <p class="mt-2">Đang tải dữ liệu...</p>
        </div>

        <!-- Card View Mode -->
        <div class="row" *ngIf="viewMode === 'card' && filteredServices && filteredServices.length > 0 && !isLoading">
          <div class="col-md-4 col-xl-3 mb-4" *ngFor="let service of filteredServices">
            <div class="service-card">
              <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span class="service-id">#{{service.id}}</span>
                </div>
                <div class="card-body service-details">
                  <div class="mb-3">
                    <div class="service-icon mb-3 text-primary">
                      <i class="mdi {{service.icon}} mdi-36px"></i>
                    </div>
                    <h5 class="mb-1">{{service.name}}</h5>
                    <p class="text-muted mb-0">{{service.description}}</p>
                  </div>
                </div>
                <div class="card-footer">
                  <div class="d-flex">
                    <button type="button" class="btn btn-sm btn-outline-primary flex-grow-1 me-1" data-bs-toggle="modal"
                      data-bs-target="#edit-modal" (click)="getServiceById(service.id)">
                      <i class="mdi mdi-pencil me-1"></i> Sửa
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger flex-grow-1"
                      (click)="deleteService(service.id)">
                      <i class="mdi mdi-delete me-1"></i> Xóa
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty state when no data -->
        <div class="row" *ngIf="filteredServices && filteredServices.length === 0 && !isLoading">
          <div class="col-12">
            <div class="text-center py-5">
              <i class="mdi mdi-emoticon-sad-outline text-muted" style="font-size: 4rem;"></i>
              <h5 class="mt-3">Không tìm thấy dữ liệu dịch vụ</h5>
              <p class="text-muted">Không có dịch vụ nào phù hợp với các tiêu chí tìm kiếm của bạn.</p>
              <button class="btn btn-primary" (click)="clearFilters()">Đặt lại bộ lọc</button>
            </div>
          </div>
        </div>

        <!-- Table View Mode -->
        <div class="row" *ngIf="viewMode === 'table' && !isLoading">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-centered table-hover">
                    <thead class="table-light">
                      <tr>
                        <th style="width: 50px;">ID</th>
                        <th style="width: 70px;">Icon</th>
                        <th>Tên dịch vụ</th>
                        <th>Mô tả</th>
                        <th style="width: 120px;">Thao tác</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let service of filteredServices">
                        <td>
                          <span class="fw-bold">#{{service.id}}</span>
                        </td>
                        <td>
                          <i class="mdi {{service.icon}} mdi-24px text-primary"></i>
                        </td>
                        <td>
                          {{service.name}}
                        </td>
                        <td>
                          {{service.description}}
                        </td>
                        <td>
                          <div class="d-flex">
                            <button type="button" class="btn btn-sm btn-light me-1" data-bs-toggle="modal"
                              data-bs-target="#edit-modal" (click)="getServiceById(service.id)">
                              <i class="mdi mdi-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-light" (click)="deleteService(service.id)">
                              <i class="mdi mdi-delete"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Pagination -->
                <div class="custom-pagination mt-4">
                  <nav>
                    <ul class="pagination">
                      <li class="page-item" [ngClass]="{'disabled': currentPage === 1}">
                        <a class="page-link" href="javascript:void(0);" (click)="goToPage(currentPage - 1)">
                          <i class="mdi mdi-chevron-left"></i>
                        </a>
                      </li>
                      <li class="page-item" *ngFor="let page of getPageNumbers()"
                        [ngClass]="{'active': page === currentPage}">
                        <a class="page-link" href="javascript:void(0);" (click)="goToPage(page)">{{page}}</a>
                      </li>
                      <li class="page-item" [ngClass]="{'disabled': currentPage === totalPages}">
                        <a class="page-link" href="javascript:void(0);" (click)="goToPage(currentPage + 1)">
                          <i class="mdi mdi-chevron-right"></i>
                        </a>
                      </li>
                    </ul>
                  </nav>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Service Modal -->
<div class="modal fade custom-modal" id="service-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Thêm dịch vụ phòng mới</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true"
          id="service-modal-close"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="serviceForm">
          <div class="row g-3">
            <div class="col-12">
              <div class="form-group">
                <label class="form-label">Tên dịch vụ <span class="text-danger">*</span></label>
                <input type="text" formControlName="name" class="form-control" placeholder="Nhập tên dịch vụ">
                <div class="invalid-feedback d-block"
                  *ngIf="serviceForm.get('name')?.invalid && serviceForm.get('name')?.touched">
                  Vui lòng nhập tên dịch vụ
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="form-group">
                <label class="form-label">Icon <span class="text-danger">*</span></label>
                <input type="text" formControlName="icon" class="form-control" placeholder="Ví dụ: mdi-wifi">
                <div class="invalid-feedback d-block"
                  *ngIf="serviceForm.get('icon')?.invalid && serviceForm.get('icon')?.touched">
                  Vui lòng nhập icon
                </div>
                <small class="form-text text-muted">Nhập mã icon từ thư viện Material Design Icons</small>
              </div>
            </div>
            <div class="col-12">
              <div class="form-group">
                <label class="form-label">Mô tả <span class="text-danger">*</span></label>
                <textarea formControlName="description" class="form-control" rows="3"
                  placeholder="Nhập mô tả dịch vụ"></textarea>
                <div class="invalid-feedback d-block"
                  *ngIf="serviceForm.get('description')?.invalid && serviceForm.get('description')?.touched">
                  Vui lòng nhập mô tả
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" (click)="createService()">Lưu dịch vụ</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Service Modal -->
<div class="modal fade custom-modal" id="edit-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Cập nhật dịch vụ phòng</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true"
          id="edit-modal-close"></button>
      </div>
      <div class="modal-body" *ngIf="selectedService">
        <form [formGroup]="editServiceForm">
          <div class="row g-3">
            <div class="col-12">
              <div class="form-group">
                <label class="form-label">Tên dịch vụ <span class="text-danger">*</span></label>
                <input type="text" formControlName="name" class="form-control" placeholder="Nhập tên dịch vụ">
                <div class="invalid-feedback d-block"
                  *ngIf="editServiceForm.get('name')?.invalid && editServiceForm.get('name')?.touched">
                  Vui lòng nhập tên dịch vụ
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="form-group">
                <label class="form-label">Icon <span class="text-danger">*</span></label>
                <input type="text" formControlName="icon" class="form-control" placeholder="Ví dụ: mdi-wifi">
                <div class="invalid-feedback d-block"
                  *ngIf="editServiceForm.get('icon')?.invalid && editServiceForm.get('icon')?.touched">
                  Vui lòng nhập icon
                </div>
                <small class="form-text text-muted">Nhập mã icon từ thư viện Material Design Icons</small>
              </div>
            </div>
            <div class="col-12">
              <div class="form-group">
                <label class="form-label">Mô tả <span class="text-danger">*</span></label>
                <textarea formControlName="description" class="form-control" rows="3"
                  placeholder="Nhập mô tả dịch vụ"></textarea>
                <div class="invalid-feedback d-block"
                  *ngIf="editServiceForm.get('description')?.invalid && editServiceForm.get('description')?.touched">
                  Vui lòng nhập mô tả
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" (click)="updateService()">Cập nhật</button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" *ngIf="isLoading">
  <div class="spinner-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Đang tải...</span>
    </div>
    <p class="mt-2">Đang xử lý...</p>
  </div>
</div>